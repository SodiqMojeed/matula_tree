<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Matula Tree Plotter</title>

  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #cy {
      width: 600px;
      height: 500px;
      border: 2px solid #ccc;
      border-radius: 6px;
      margin-top: 15px;
    }
    #saveBtn {
      margin-left: 10px;
    }
  </style>
</head>

<body>

<h2>Matula Numbers of Rooted Trees</h2>

<p>Enter a natural number:</p>
<input id="numInput" type="number" min="1" style="width:150px;">
<button onclick="plot()">Plot Tree</button>
<button id="saveBtn" onclick="saveImage()">Save Plot</button>

<div id="cy"></div>

<script>
/* ----------------------------------------------------------
   PRIME UTILITIES
---------------------------------------------------------- */
function isPrime(n) {
  if (n < 2) return false;
  if (n % 2 === 0) return n === 2;
  for (let i = 3; i * i <= n; i += 2) {
    if (n % i === 0) return false;
  }
  return true;
}

function primeIndex(p) {
  let count = 0;
  for (let x = 2; x <= p; x++) if (isPrime(x)) count++;
  return count;
}

/* ----------------------------------------------------------
   MATULA TREE BUILDER
---------------------------------------------------------- */
function matulaTree(n) {
  if (n === 1) return { value: 1, children: [] };

  if (isPrime(n)) {
    return { value: n, children: [matulaTree(primeIndex(n))] };
  }

  for (let a = 2; a * a <= n; a++) {
    if (n % a === 0) {
      const b = n / a;
      const left = matulaTree(a);
      const right = matulaTree(b);
      return { value: n, children: [...left.children, ...right.children] };
    }
  }
}

/* ----------------------------------------------------------
   CONVERT TO FIXED-POSITION NODES (VERTICAL TREE)
---------------------------------------------------------- */
function toCytoscapeElements(tree) {
  let elements = [];
  let id = 0;

  const levels = [];

  function traverse(node, depth = 0) {
    const nodeId = "n" + (id++);
    if (!levels[depth]) levels[depth] = [];
    levels[depth].push(nodeId);

    elements.push({
      data: { id: nodeId, label: node.value }
    });

    node.children.forEach(child => {
      const childId = traverse(child, depth + 1);
      elements.push({
        data: { source: nodeId, target: childId }
      });
    });

    return nodeId;
  }

  traverse(tree);

  // Position nodes in neat vertical layers
  const xSpacing = 80;
  const ySpacing = 90;

  levels.forEach((levelNodes, depth) => {
    const startX = -(levelNodes.length - 1) * xSpacing / 2;
    levelNodes.forEach((nodeId, i) => {
      elements.find(e => e.data.id === nodeId).position = {
        x: startX + i * xSpacing,
        y: depth * ySpacing
      };
    });
  });

  return elements;
}

/* ----------------------------------------------------------
   RENDER CLEAN VERTICAL TREE (NO ARROWS)
---------------------------------------------------------- */
let cy;  // keep global reference for saving

function renderTree(elements) {
  cy = cytoscape({
    container: document.getElementById('cy'),

    elements: elements,
    layout: { name: 'preset' },

    style: [
      {
        selector: 'node',
        style: {
          'background-color': '#4A8CF7',
          'width': 28,
          'height': 28,
          'label': 'data(label)',
          'color': 'white',
          'font-size': 12,
          'text-valign': 'center',
          'text-outline-color': '#4A8CF7',
          'text-outline-width': 2
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 2,
          'line-color': '#444',
          'curve-style': 'straight'   /* straight non-directed edges */
        }
      }
    ],

    boxSelectionEnabled: false,
    userZoomingEnabled: true,
    userPanningEnabled: true
  });
}

/* ----------------------------------------------------------
   SAVE / DOWNLOAD THE CURRENT PLOT
---------------------------------------------------------- */
function saveImage() {
  if (!cy) return;

  const png = cy.png({
    output: 'blob',
    full: true,
    scale: 2
  });

  const url = URL.createObjectURL(png);
  const link = document.createElement('a');
  link.href = url;
  link.download = "matula_tree.png";
  link.click();
  URL.revokeObjectURL(url);
}

/* ----------------------------------------------------------
   PLOT
---------------------------------------------------------- */
function plot() {
  const n = parseInt(document.getElementById("numInput").value);
  const tree = matulaTree(n);
  const elements = toCytoscapeElements(tree);
  renderTree(elements);
}

plot();
</script>

</body>
</html>
